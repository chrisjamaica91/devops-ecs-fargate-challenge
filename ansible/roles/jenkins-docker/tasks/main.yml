---
- name: Create Jenkins directory
  file:
    path: /opt/jenkins
    state: directory
    mode: '0755'
  tags: jenkins

- name: Deploy Jenkins Dockerfile
  template:
    src: Dockerfile.j2
    dest: /opt/jenkins/Dockerfile
    mode: '0644'
  tags: jenkins
  notify: rebuild jenkins image

- name: Build Jenkins Docker image
  command: docker build -t jenkins-with-docker:latest /opt/jenkins
  args:
    chdir: /opt/jenkins
  tags: jenkins

- name: Check if Jenkins container exists
  command: docker ps -aq -f name=jenkins
  register: jenkins_container
  changed_when: false
  tags: jenkins

- name: Stop and remove existing Jenkins container
  command: docker rm -f jenkins
  when: jenkins_container.stdout != ""
  tags: jenkins

- name: Create docker volume for Jenkins
  command: docker volume create jenkins_home
  register: volume_result
  changed_when: "'jenkins_home' not in volume_result.stdout"
  failed_when: false
  tags: jenkins

- name: Install Trivy security scanner
  shell: |
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
  args:
    creates: /usr/local/bin/trivy
  tags: jenkins

- name: Start Jenkins container
  command: >
    docker run -d
    --name jenkins
    --restart unless-stopped
    --privileged
    -u root
    -p 8080:8080
    -p 50000:50000
    -v jenkins_home:/var/jenkins_home
    -v /var/run/docker.sock:/var/run/docker.sock
    -e DOCKER_HOST=unix:///var/run/docker.sock
    jenkins-with-docker:latest
  tags: jenkins

- name: Wait for Jenkins to be ready
  uri:
    url: "http://localhost:8080"
    status_code: 200,403
  register: result
  until: result.status in [200, 403]
  retries: 30
  delay: 10
  tags: jenkins


- name: Install Jenkins plugins
  command: >
    docker exec jenkins jenkins-plugin-cli
    --plugins
    git
    github
    github-branch-source
    docker-workflow
    pipeline-aws
    amazon-ecr
    aws-credentials
    pipeline-stage-view
    workflow-aggregator
  tags: jenkins
  register: plugin_install
  changed_when: true

- name: Restart Jenkins to activate plugins
  command: docker restart jenkins
  when: plugin_install.changed
  tags: jenkins

- name: Get Jenkins initial admin password
  shell: docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
  register: jenkins_password
  changed_when: false
  failed_when: false
  tags: jenkins

- name: Display Jenkins admin password
  debug:
    msg: "Jenkins initial admin password: {{ jenkins_password.stdout }}"
  when: jenkins_password.stdout != ""
  tags: jenkins